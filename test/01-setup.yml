---
  - name: Deploy Dimension Data infrastructure  
    hosts: localhost
    vars:
      root_password: P$$ssWwrrdGoDd!
    vars_files:
      - caas_credentials.yml
    tasks:
      - name: Check credentials (optionnal Step)
        caas_credentials:
          username: "{{caas_credentials.username}}"
          password: "{{caas_credentials.password}}"
          apiurl: "{{caas_credentials.apiurl}}"
          datacenter: "{{caas_credentials.datacenter}}" 
      - name: Deploy my Nework Domain
        caas_networkdomain:
          caas_credentials: "{{ caas_credentials }}"
          name: "{{ lookup ('env','caas_networkdomain') }}"
          type: ADVANCED
        register: caas_networkdomain
      - name: Deploy WebServers DMZ
        caas_vlan:
          caas_credentials: "{{ caas_credentials }}"
          networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
          name: "{{caas_networkdomain.networkdomains.networkDomain[0].name}}_vlan_webservers"
          privateIpv4BaseAddress: "192.168.30.0"
        register: caas_vlan_webservers
#      - name: Deploy WebServers DMZ
#        caas_server:
#          caas_credentials: "{{ caas_credentials }}"
#          name: "MyWebServer"
#          imageName: CentOS 7 64-bit 2 CPU
#          administratorPassword: "{{ root_password }}"
#          networkInfo:
#              networkDomainName: ansible.Caas_SandBox
#              primaryNic: 
#                  privateIpv4: 192.168.30.42
#        register: caas_mywebserver
      - name: Deploy WebServers
        caas_server:
          caas_credentials: "{{ caas_credentials }}"
          wait: False
          name: "WebServer"
          #state: "absent"
          #action: shutdownServer
          count: 2
          #description: ansible.CaaS This a test, feel free to delete
          #imageId: bfe177f0-23ec-4886-a046-c516f354fd53
          imageName: CentOS 7 64-bit 2 CPU
          administratorPassword: "{{ root_password }}"
          #cpu:
              #count: 16
              #coresPerSocket: 1
              #speed: STANDARD
          networkInfo:
              #networkDomainId: fd340f41-7f93-4dda-a7f2-e46cc6302613
              networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
              primaryNic: 
                  #vlanId: 0cd34569-e3b4-46ca-9c86-3e8c2b08d732
                  vlanName: "{{caas_vlan_webservers.vlans.vlan[0].name}}"
                  #privateIpv4: 172.24.42.42
        register: caas_webservers
      - name: Deploy AppServers DMZ
        caas_vlan:
          caas_credentials: "{{ caas_credentials }}"
          networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
          name: "{{caas_networkdomain.networkdomains.networkDomain[0].name}}_vlan_appservers"
          privateIpv4BaseAddress: "192.168.40.0"
        register: caas_vlan_appservers
      - name: Deploy AppServers
        caas_server:
          caas_credentials: "{{ caas_credentials }}"
          name: "AppServer"
          wait: False
          imageName: CentOS 7 64-bit 2 CPU
          administratorPassword: "{{ root_password }}"
          networkInfo:
              networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
              primaryNic: 
                  vlanName: "{{caas_vlan_appservers.vlans.vlan[0].name}}"
        register: caas_appservers
#      - name: Deploy DBServer DMZ
#        caas_vlan:
#          caas_credentials: "{{ caas_credentials }}"
#          networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
#          name: "{{caas_networkdomain.networkdomains.networkDomain[0].name}}_vlan_dbservers"
#          privateIpv4BaseAddress: "192.168.50.0"
#        register: caas_vlan_dbservers
#      - name: Deploy DBServer
#        caas_server:
#          caas_credentials: "{{ caas_credentials }}"
#          name: "DBServer"
#          wait: True
#          imageName: CentOS 7 64-bit 2 CPU
#          administratorPassword: "{{ root_password }}"
#          networkInfo:
#              networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
#              primaryNic: 
#                  vlanName: "{{caas_vlan_dbservers.vlans.vlan[0].name}}"
#        register: caas_dbserver
      - name: Disable Default Rule that Drop Any external IPv6 connection
        caas_firewallrule:
          caas_credentials: "{{ caas_credentials }}"
          networkDomainName: "{{ caas_networkdomain.networkdomains.networkDomain[0].name }}"
          name: "CCDEFAULT.DenyExternalInboundIPv6"
          enabled: False